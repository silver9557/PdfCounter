<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PDF Page Counter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- Стили остаются прежними -->
</head>
<body>
    <!-- HTML остаётся прежним -->
    <script>
        const pdfInput = document.getElementById('pdfInput');
        const resultDiv = document.getElementById('result');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const resetBtn = document.getElementById('resetBtn');

        pdfInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            resultDiv.innerHTML = '';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            resetBtn.style.display = 'none';

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let bwCount = 0;
            let colorCount = 0;
            const totalPages = pdf.numPages;

            for (let i = 1; i <= totalPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 0.5 }); // Уменьшаем масштаб

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                if (isGrayscale(imageData)) {
                    bwCount++;
                } else {
                    colorCount++;
                }

                // Очистка
                canvas.width = 0; // Сбрасываем canvas
                const progress = (i / totalPages) * 100;
                progressBar.style.width = `${progress}%`;

                // Пауза каждые 50 страниц
                if (i % 50 === 0) await new Promise(resolve => setTimeout(resolve, 10));
            }

            progressContainer.style.display = 'none';
            resultDiv.innerHTML = `Всего страниц: ${totalPages}<br>Черно-белых страниц: ${bwCount}<br>Цветных страниц: ${colorCount}`;
            resetBtn.style.display = 'inline-block';
        });

        resetBtn.addEventListener('click', () => {
            pdfInput.value = '';
            resultDiv.innerHTML = '';
            resetBtn.style.display = 'none';
        });

        function isGrayscale(imageData) {
            const data = imageData.data;
            // Проверяем только первые 10000 пикселей (ускорение)
            for (let i = 0; i < Math.min(data.length, 40000); i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                if (Math.abs(r - g) > 10 || Math.abs(g - b) > 10 || Math.abs(b - r) > 10) {
                    return false;
                }
            }
            return true;
        }
    </script>
</body>
</html>
​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​​
